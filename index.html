<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
        <!-- Remove this when import maps will be widely supported -->
		<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>


        <!-- Needed to make the import "three" work-->
		<script type="importmap">
			{
				"imports": {
					"three": "../node_modules/three/build/three.module.js"
				}
			}
		</script>

		<!-- <script src="../node_modules/tween.js/dist/tween.umd.js"></script> -->

		<script type="module">
        import * as THREE from '../node_modules/three/build/three.module.js';
        import { OrbitControls } from '../node_modules/three/examples/jsm/controls/OrbitControls.js';
		import * as CANNON from '../node_modules/cannon-es/dist/cannon-es.js';
		import {GLTFLoader} from '../node_modules/three/examples/jsm/loaders/GLTFLoader.js';
		import { TWEEN } from '../node_modules/three/examples/jsm/libs/tween.module.min.js'

		var relDir=Math.PI;
		var playerState = "Idle";
		var cameraTarget = new THREE.Vector3();
		var mixer;
		var archerModel, archerModelParent;
		var arrowModel, targetModel, targetModel1, targetModel2;
		var targetModelParent1, targetModelParent2;
		var archerStructure = {};
		var canShoot=true;
		var lastExecutedAnimation = "Idle";
		var idle, runA, runB, jumpA, jumpB, walkA, walkB, shootA, shootB, shootC;
		var arrows =[];

		//CANNON AND THREE SETUP
		const world = new CANNON.World({
			gravity: new CANNON.Vec3(0, -9.81, 0)
		});

		const scene = new THREE.Scene();
		scene.background = new THREE.Color( 0xffeeee );
		const camera = new THREE.PerspectiveCamera(
			45,
			window.innerWidth / window.innerHeight,
			0.1,
			1000
		);
		camera.position.set(0, 10, -8);

		const renderer = new THREE.WebGLRenderer();
		renderer.setSize( window.innerWidth, window.innerHeight );
		renderer.shadowMap.enabled = true;
		document.body.appendChild( renderer.domElement );

		const orbit = new OrbitControls(camera, renderer.domElement);

		orbit.update();
		
		//LIGHT SETUP

		const ambLight = new THREE.AmbientLight(0xFFFFFF, 0.8);
		scene.add(ambLight);

		const dirLight = new THREE.DirectionalLight(0xFFFFFF, 10);
		dirLight.position.set(40, 40, 0);
		dirLight.target.position.set(-2, 0, 0);
		dirLight.castShadow = true; 
		renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap
		dirLight.shadow.camera.left = - 15;
		dirLight.shadow.camera.right = 15;
		dirLight.shadow.camera.top = 15;
		dirLight.shadow.camera.bottom = - 15;
		dirLight.shadow.camera.far = 35000;
		dirLight.shadow.bias = - 0;
		scene.add(dirLight);
		scene.add(dirLight.target);

		const helper = new THREE.CameraHelper( dirLight.shadow.camera );
		scene.add( helper )
		//CUBE (THREE)
		const cubeGeometry = new THREE.BoxGeometry( 1.4, 3.0, 2.0 );
		const cubeMaterial = new THREE.MeshPhongMaterial( { color: 0x00ff00, wireframe: true} );
		const cubeMesh = new THREE.Mesh( cubeGeometry, cubeMaterial );
		//scene.add( cubeMesh );
		cubeMesh.castShadow=true;
		//cubeMesh.receiveShadow=true;
		// var cubeMesh;
		const gltfLoader = new GLTFLoader();

		gltfLoader.load("gltf/arrow/scene.gltf", (gltf) => {
			arrowModel = gltf.scene.getObjectByName("Sketchfab_Scene");
			arrowModel.scale.setScalar( 0.01 );
		});

		gltfLoader.load("gltf/target/scene.gltf", (gltf) => {
			targetModel = gltf.scene.getObjectByName("Sketchfab_Scene");
			targetModel.scale.setScalar( 0.3 );
			targetModelParent1 = new THREE.Object3D();
			targetModelParent2 = new THREE.Object3D();
			targetModel1 = targetModel.clone();
			targetModel2 = targetModel.clone();
			targetModel1.getWorldPosition(targetModelParent1.position);
			targetModel1.rotation.set(...[Math.PI/2,0,0]);
			targetModelParent1.add(targetModel1);
			scene.add(targetModelParent1);

			targetModel2.getWorldPosition(targetModelParent2.position);
			targetModel2.rotation.set(...[Math.PI/2,0,0]);
			targetModelParent2.add(targetModel2);
			scene.add(targetModelParent2);
		});

		const url = 'gltf/archer/scene.gltf';
		
		gltfLoader.load(url, (gltf) => {
			archerModel = gltf.scene.getObjectByName("Sketchfab_Scene");

			archerModel.scale.setScalar( 1.7 );
			//Creating a parent to move the archerModel through its center and rotate it in the correct direction
			archerModelParent = new THREE.Object3D();
			archerModel.getWorldPosition(archerModelParent.position);
			archerModel.position.set(0, -cubeMesh.geometry.parameters.height/2, 0);
			archerModel.rotation.set(...[0,Math.PI,0]);
			archerModelParent.add(archerModel);
			scene.add(archerModelParent);
			
			gltf.scene.traverse( function( node ) {
				if (node.isMesh) { 
					node.castShadow = true;
					node.receiveShadow=true;
			}
			} );

			//Setting only the basic animation, after we're going to animate it ourserlves
			const animations = gltf.animations;
			mixer = new THREE.AnimationMixer(archerModel);

			mixer.clipAction(animations[2]).play();
			if (mixer) mixer.update();
			
			//Set the components useful for creating animations with TweenJS
			populateArcherStructure();

			changePlayerState("Idle");
			archerStructure["rightUpperArm"].rotation.z += Math.PI/2.3;
			archerStructure["leftUpperArm"].rotation.z -= Math.PI/2.3;
			archerStructure["rightHandPinky2"].rotation.z = Math.PI/3;
			archerStructure["rightHandPinky3"].rotation.z = Math.PI/3; 
			archerStructure["rightHandPinky4"].rotation.z = Math.PI/3; 
			archerStructure["rightHandRing2"].rotation.z = Math.PI/3; 
			archerStructure["rightHandRing3"].rotation.z = Math.PI/3; 
			archerStructure["rightHandRing4"].rotation.z = Math.PI/3; 
			archerStructure["rightHandMiddle2"].rotation.z = Math.PI/3; 
			archerStructure["rightHandMiddle3"].rotation.z = Math.PI/3; 
			archerStructure["rightHandMiddle4"].rotation.z = Math.PI/3; 
			archerStructure["rightHandIndex2"].rotation.z = Math.PI/3; 
			archerStructure["rightHandIndex3"].rotation.z = Math.PI/3; 
			archerStructure["rightHandIndex4"].rotation.z = Math.PI/3; 
			archerStructure["rightHandThumb2"].rotation.y = -Math.PI/4; 
			archerStructure["rightHandThumb3"].rotation.y = -Math.PI/4; 
			archerStructure["rightHandThumb4"].rotation.y = -Math.PI/4;
			archerStructure["rightHandThumb2"].rotation.z = -Math.PI/12; 
			archerStructure["rightHandThumb3"].rotation.z = -Math.PI/12; 
			archerStructure["rightHandThumb4"].rotation.z = -Math.PI/12; 
			archerStructure["leftHandPinky2"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandPinky3"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandPinky4"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandRing2"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandRing3"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandRing4"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandMiddle2"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandMiddle3"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandMiddle4"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandIndex2"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandIndex3"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandIndex4"].rotation.z = -Math.PI/3; 
			archerStructure["leftHandThumb2"].rotation.y = Math.PI/4; 
			archerStructure["leftHandThumb3"].rotation.y = Math.PI/4; 
			archerStructure["leftHandThumb4"].rotation.y = Math.PI/4;
			archerStructure["leftHandThumb2"].rotation.z = Math.PI/12; 
			archerStructure["leftHandThumb3"].rotation.z = Math.PI/12; 
			archerStructure["leftHandThumb4"].rotation.z = Math.PI/12; 
			var out = "";
			// Object.keys(archerStructure).forEach(key => {
			// out += ('"'+ key + 'Rx": ' + archerStructure[key].rotation.x.toFixed(4) + ',' +'"'+ key + 'Ry": ' + archerStructure[key].rotation.y.toFixed(4) + ',' + '"'+ key + 'Rz": ' + archerStructure[key].rotation.z.toFixed(4) + ', \n');				
			// });			
			// Object.keys(archerStructure).forEach(key => {
			// out += ('"'+ key + 'Rx": ' + 'archerStructure["'+ key + '"].rotation.x' + ',' +'"'+ key + 'Ry": ' + 'archerStructure["'+ key + '"].rotation.y' + ',' + '"'+ key + 'Rz": ' + 'archerStructure["'+ key + '"].rotation.z'+ ', \n');				
			// });			
			// Object.keys(archerStructure).forEach(key => {
			// out += ('archerStructure["'+ key + '"].rotation.x = ' + 'object["'+ key + 'Rx"]' +  ';' +'archerStructure["'+ key + '"].rotation.y = ' + 'object["'+ key + 'Ry"]' + ';' + 'archerStructure["'+ key + '"].rotation.z = ' + 'object["'+ key + 'Rz"]' +  '; \n');				
			// });
			console.log(out);
			console.log(dumpObject(archerModel).join('\n'));
			
			//TWEEN ANIMATIONS
			//var groupPlayer = new TWEEN.Group();
			var startRotations ={"rightShoulderRx": archerStructure["rightShoulder"].rotation.x,"rightShoulderRy": archerStructure["rightShoulder"].rotation.y,"rightShoulderRz": archerStructure["rightShoulder"].rotation.z, 
								"rightUpperArmRx": archerStructure["rightUpperArm"].rotation.x,"rightUpperArmRy": archerStructure["rightUpperArm"].rotation.y,"rightUpperArmRz": archerStructure["rightUpperArm"].rotation.z, 
								"rightLowerArmRx": archerStructure["rightLowerArm"].rotation.x,"rightLowerArmRy": archerStructure["rightLowerArm"].rotation.y,"rightLowerArmRz": archerStructure["rightLowerArm"].rotation.z, 
								"rightHandRx": archerStructure["rightHand"].rotation.x,"rightHandRy": archerStructure["rightHand"].rotation.y,"rightHandRz": archerStructure["rightHand"].rotation.z, 
								"leftShoulderRx": archerStructure["leftShoulder"].rotation.x,"leftShoulderRy": archerStructure["leftShoulder"].rotation.y,"leftShoulderRz": archerStructure["leftShoulder"].rotation.z, 
								"leftUpperArmRx": archerStructure["leftUpperArm"].rotation.x,"leftUpperArmRy": archerStructure["leftUpperArm"].rotation.y,"leftUpperArmRz": archerStructure["leftUpperArm"].rotation.z, 
								"leftLowerArmRx": archerStructure["leftLowerArm"].rotation.x,"leftLowerArmRy": archerStructure["leftLowerArm"].rotation.y,"leftLowerArmRz": archerStructure["leftLowerArm"].rotation.z, 
								"leftHandRx": archerStructure["leftHand"].rotation.x,"leftHandRy": archerStructure["leftHand"].rotation.y,"leftHandRz": archerStructure["leftHand"].rotation.z, 
								"rightUpperLegRx": archerStructure["rightUpperLeg"].rotation.x,"rightUpperLegRy": archerStructure["rightUpperLeg"].rotation.y,"rightUpperLegRz": archerStructure["rightUpperLeg"].rotation.z, 
								"rightLowerLegRx": archerStructure["rightLowerLeg"].rotation.x,"rightLowerLegRy": archerStructure["rightLowerLeg"].rotation.y,"rightLowerLegRz": archerStructure["rightLowerLeg"].rotation.z, 
								"rightFootRx": archerStructure["rightFoot"].rotation.x,"rightFootRy": archerStructure["rightFoot"].rotation.y,"rightFootRz": archerStructure["rightFoot"].rotation.z, 
								"leftUpperLegRx": archerStructure["leftUpperLeg"].rotation.x,"leftUpperLegRy": archerStructure["leftUpperLeg"].rotation.y,"leftUpperLegRz": archerStructure["leftUpperLeg"].rotation.z, 
								"leftLowerLegRx": archerStructure["leftLowerLeg"].rotation.x,"leftLowerLegRy": archerStructure["leftLowerLeg"].rotation.y,"leftLowerLegRz": archerStructure["leftLowerLeg"].rotation.z, 
								"leftFootRx": archerStructure["leftFoot"].rotation.x,"leftFootRy": archerStructure["leftFoot"].rotation.y,"leftFootRz": archerStructure["leftFoot"].rotation.z, 
								"neckRx": archerStructure["neck"].rotation.x,"neckRy": archerStructure["neck"].rotation.y,"neckRz": archerStructure["neck"].rotation.z, 
								"headRx": archerStructure["head"].rotation.x,"headRy": archerStructure["head"].rotation.y,"headRz": archerStructure["head"].rotation.z, 
								"rightHandPinky2Rz": archerStructure["rightHandPinky2"].rotation.z, 
								"rightHandPinky3Rz": archerStructure["rightHandPinky3"].rotation.z, 
								"rightHandPinky4Rz": archerStructure["rightHandPinky4"].rotation.z, 
								"rightHandRing2Rz": archerStructure["rightHandRing2"].rotation.z, 
								"rightHandRing3Rz": archerStructure["rightHandRing3"].rotation.z, 
								"rightHandRing4Rz": archerStructure["rightHandRing4"].rotation.z, 
								"rightHandMiddle2Rz": archerStructure["rightHandMiddle2"].rotation.z, 
								"rightHandMiddle3Rz": archerStructure["rightHandMiddle3"].rotation.z, 
								"rightHandMiddle4Rz": archerStructure["rightHandMiddle4"].rotation.z, 
								"rightHandIndex2Rz": archerStructure["rightHandIndex2"].rotation.z, 
								"rightHandIndex3Rz": archerStructure["rightHandIndex3"].rotation.z, 
								"rightHandIndex4Rz": archerStructure["rightHandIndex4"].rotation.z, 
								"rightHandThumb2Rz": archerStructure["rightHandThumb2"].rotation.z, 
								"rightHandThumb3Rz": archerStructure["rightHandThumb3"].rotation.z, 
								"rightHandThumb4Rz": archerStructure["rightHandThumb4"].rotation.z,
								"rightHandThumb2Ry": archerStructure["rightHandThumb2"].rotation.y,
								"rightHandThumb3Ry": archerStructure["rightHandThumb3"].rotation.y,
								"rightHandThumb4Ry": archerStructure["rightHandThumb4"].rotation.y, 
								"leftHandPinky2Rz": archerStructure["leftHandPinky2"].rotation.z, 
								"leftHandPinky3Rz": archerStructure["leftHandPinky3"].rotation.z, 
								"leftHandPinky4Rz": archerStructure["leftHandPinky4"].rotation.z, 
								"leftHandRing2Rz": archerStructure["leftHandRing2"].rotation.z, 
								"leftHandRing3Rz": archerStructure["leftHandRing3"].rotation.z, 
								"leftHandRing4Rz": archerStructure["leftHandRing4"].rotation.z, 
								"leftHandMiddle2Rz": archerStructure["leftHandMiddle2"].rotation.z, 
								"leftHandMiddle3Rz": archerStructure["leftHandMiddle3"].rotation.z, 
								"leftHandMiddle4Rz": archerStructure["leftHandMiddle4"].rotation.z, 
								"leftHandIndex2Rz": archerStructure["leftHandIndex2"].rotation.z, 
								"leftHandIndex3Rz": archerStructure["leftHandIndex3"].rotation.z, 
								"leftHandIndex4Rz": archerStructure["leftHandIndex4"].rotation.z, 
								"leftHandThumb2Rz": archerStructure["leftHandThumb2"].rotation.z, 
								"leftHandThumb3Rz": archerStructure["leftHandThumb3"].rotation.z, 
								"leftHandThumb4Rz": archerStructure["leftHandThumb4"].rotation.z,
								"leftHandThumb2Ry": archerStructure["leftHandThumb2"].rotation.y, 
								"leftHandThumb3Ry": archerStructure["leftHandThumb3"].rotation.y, 
								"leftHandThumb4Ry": archerStructure["leftHandThumb4"].rotation.y
								};
			
			const updateFunction = function (object, elapsedTime) {
				//If the player is not shooting then you can move the upper part of the body
				if(canShoot){
					archerStructure["rightShoulder"].rotation.x = object["rightShoulderRx"];archerStructure["rightShoulder"].rotation.y = object["rightShoulderRy"];archerStructure["rightShoulder"].rotation.z = object["rightShoulderRz"]; 
					archerStructure["rightUpperArm"].rotation.x = object["rightUpperArmRx"];archerStructure["rightUpperArm"].rotation.y = object["rightUpperArmRy"];archerStructure["rightUpperArm"].rotation.z = object["rightUpperArmRz"]; 
					archerStructure["rightLowerArm"].rotation.x = object["rightLowerArmRx"];archerStructure["rightLowerArm"].rotation.y = object["rightLowerArmRy"];archerStructure["rightLowerArm"].rotation.z = object["rightLowerArmRz"]; 
					archerStructure["rightHand"].rotation.x = object["rightHandRx"];archerStructure["rightHand"].rotation.y = object["rightHandRy"];archerStructure["rightHand"].rotation.z = object["rightHandRz"]; 
					archerStructure["leftShoulder"].rotation.x = object["leftShoulderRx"];archerStructure["leftShoulder"].rotation.y = object["leftShoulderRy"];archerStructure["leftShoulder"].rotation.z = object["leftShoulderRz"]; 
					archerStructure["leftUpperArm"].rotation.x = object["leftUpperArmRx"];archerStructure["leftUpperArm"].rotation.y = object["leftUpperArmRy"];archerStructure["leftUpperArm"].rotation.z = object["leftUpperArmRz"]; 
					archerStructure["leftLowerArm"].rotation.x = object["leftLowerArmRx"];archerStructure["leftLowerArm"].rotation.y = object["leftLowerArmRy"];archerStructure["leftLowerArm"].rotation.z = object["leftLowerArmRz"]; 
					archerStructure["leftHand"].rotation.x = object["leftHandRx"];archerStructure["leftHand"].rotation.y = object["leftHandRy"];archerStructure["leftHand"].rotation.z = object["leftHandRz"]; 
					archerStructure["neck"].rotation.x = object["neckRx"];archerStructure["neck"].rotation.y = object["neckRy"];archerStructure["neck"].rotation.z = object["neckRz"]; 
					archerStructure["head"].rotation.x = object["headRx"];archerStructure["head"].rotation.y = object["headRy"];archerStructure["head"].rotation.z = object["headRz"]; 
					archerStructure["rightHandPinky2"].rotation.z = object["rightHandPinky2Rz"]; 
					archerStructure["rightHandPinky3"].rotation.z = object["rightHandPinky3Rz"]; 
					archerStructure["rightHandPinky4"].rotation.z = object["rightHandPinky4Rz"]; 
					archerStructure["rightHandRing2"].rotation.z = object["rightHandRing2Rz"]; 
					archerStructure["rightHandRing3"].rotation.z = object["rightHandRing3Rz"]; 
					archerStructure["rightHandRing4"].rotation.z = object["rightHandRing4Rz"]; 
					archerStructure["rightHandMiddle2"].rotation.z = object["rightHandMiddle2Rz"]; 
					archerStructure["rightHandMiddle3"].rotation.z = object["rightHandMiddle3Rz"]; 
					archerStructure["rightHandMiddle4"].rotation.z = object["rightHandMiddle4Rz"]; 
					archerStructure["rightHandIndex2"].rotation.z = object["rightHandIndex2Rz"]; 
					archerStructure["rightHandIndex3"].rotation.z = object["rightHandIndex3Rz"]; 
					archerStructure["rightHandIndex4"].rotation.z = object["rightHandIndex4Rz"]; 
					archerStructure["rightHandThumb2"].rotation.y = object["rightHandThumb2Ry"];archerStructure["rightHandThumb2"].rotation.z = object["rightHandThumb2Rz"]; 
					archerStructure["rightHandThumb3"].rotation.y = object["rightHandThumb3Ry"];archerStructure["rightHandThumb3"].rotation.z = object["rightHandThumb3Rz"]; 
					archerStructure["rightHandThumb4"].rotation.y = object["rightHandThumb4Ry"];archerStructure["rightHandThumb4"].rotation.z = object["rightHandThumb4Rz"]; 
					archerStructure["leftHandPinky2"].rotation.z = object["leftHandPinky2Rz"]; 
					archerStructure["leftHandPinky3"].rotation.z = object["leftHandPinky3Rz"]; 
					archerStructure["leftHandPinky4"].rotation.z = object["leftHandPinky4Rz"]; 
					archerStructure["leftHandRing2"].rotation.z = object["leftHandRing2Rz"]; 
					archerStructure["leftHandRing3"].rotation.z = object["leftHandRing3Rz"]; 
					archerStructure["leftHandRing4"].rotation.z = object["leftHandRing4Rz"]; 
					archerStructure["leftHandMiddle2"].rotation.z = object["leftHandMiddle2Rz"]; 
					archerStructure["leftHandMiddle3"].rotation.z = object["leftHandMiddle3Rz"]; 
					archerStructure["leftHandMiddle4"].rotation.z = object["leftHandMiddle4Rz"]; 
					archerStructure["leftHandIndex2"].rotation.z = object["leftHandIndex2Rz"]; 
					archerStructure["leftHandIndex3"].rotation.z = object["leftHandIndex3Rz"]; 
					archerStructure["leftHandIndex4"].rotation.z = object["leftHandIndex4Rz"]; 
					archerStructure["leftHandThumb2"].rotation.y = object["leftHandThumb2Ry"];archerStructure["leftHandThumb2"].rotation.z = object["leftHandThumb2Rz"]; 
					archerStructure["leftHandThumb3"].rotation.y = object["leftHandThumb3Ry"];archerStructure["leftHandThumb3"].rotation.z = object["leftHandThumb3Rz"]; 
					archerStructure["leftHandThumb4"].rotation.y = object["leftHandThumb4Ry"];archerStructure["leftHandThumb4"].rotation.z = object["leftHandThumb4Rz"]; 	
				}			
				archerStructure["rightUpperLeg"].rotation.x = object["rightUpperLegRx"];archerStructure["rightUpperLeg"].rotation.y = object["rightUpperLegRy"];archerStructure["rightUpperLeg"].rotation.z = object["rightUpperLegRz"]; 
				archerStructure["rightLowerLeg"].rotation.x = object["rightLowerLegRx"];archerStructure["rightLowerLeg"].rotation.y = object["rightLowerLegRy"];archerStructure["rightLowerLeg"].rotation.z = object["rightLowerLegRz"]; 
				archerStructure["rightFoot"].rotation.x = object["rightFootRx"];archerStructure["rightFoot"].rotation.y = object["rightFootRy"];archerStructure["rightFoot"].rotation.z = object["rightFootRz"]; 
				archerStructure["leftUpperLeg"].rotation.x = object["leftUpperLegRx"];archerStructure["leftUpperLeg"].rotation.y = object["leftUpperLegRy"];archerStructure["leftUpperLeg"].rotation.z = object["leftUpperLegRz"]; 
				archerStructure["leftLowerLeg"].rotation.x = object["leftLowerLegRx"];archerStructure["leftLowerLeg"].rotation.y = object["leftLowerLegRy"];archerStructure["leftLowerLeg"].rotation.z = object["leftLowerLegRz"]; 
				archerStructure["leftFoot"].rotation.x = object["leftFootRx"];archerStructure["leftFoot"].rotation.y = object["leftFootRy"];archerStructure["leftFoot"].rotation.z = object["leftFootRz"]; 
			};

			const updateFunctionUpper = function (object, elapsedTime) {
				archerStructure["rightShoulder"].rotation.x = object["rightShoulderRx"];archerStructure["rightShoulder"].rotation.y = object["rightShoulderRy"];archerStructure["rightShoulder"].rotation.z = object["rightShoulderRz"]; 
				archerStructure["rightUpperArm"].rotation.x = object["rightUpperArmRx"];archerStructure["rightUpperArm"].rotation.y = object["rightUpperArmRy"];archerStructure["rightUpperArm"].rotation.z = object["rightUpperArmRz"]; 
				archerStructure["rightLowerArm"].rotation.x = object["rightLowerArmRx"];archerStructure["rightLowerArm"].rotation.y = object["rightLowerArmRy"];archerStructure["rightLowerArm"].rotation.z = object["rightLowerArmRz"]; 
				archerStructure["rightHand"].rotation.x = object["rightHandRx"];archerStructure["rightHand"].rotation.y = object["rightHandRy"];archerStructure["rightHand"].rotation.z = object["rightHandRz"]; 
				archerStructure["leftShoulder"].rotation.x = object["leftShoulderRx"];archerStructure["leftShoulder"].rotation.y = object["leftShoulderRy"];archerStructure["leftShoulder"].rotation.z = object["leftShoulderRz"]; 
				archerStructure["leftUpperArm"].rotation.x = object["leftUpperArmRx"];archerStructure["leftUpperArm"].rotation.y = object["leftUpperArmRy"];archerStructure["leftUpperArm"].rotation.z = object["leftUpperArmRz"]; 
				archerStructure["leftLowerArm"].rotation.x = object["leftLowerArmRx"];archerStructure["leftLowerArm"].rotation.y = object["leftLowerArmRy"];archerStructure["leftLowerArm"].rotation.z = object["leftLowerArmRz"]; 
				archerStructure["leftHand"].rotation.x = object["leftHandRx"];archerStructure["leftHand"].rotation.y = object["leftHandRy"];archerStructure["leftHand"].rotation.z = object["leftHandRz"]; 
				archerStructure["neck"].rotation.x = object["neckRx"];archerStructure["neck"].rotation.y = object["neckRy"];archerStructure["neck"].rotation.z = object["neckRz"]; 
				archerStructure["head"].rotation.x = object["headRx"];archerStructure["head"].rotation.y = object["headRy"];archerStructure["head"].rotation.z = object["headRz"]; 
				archerStructure["rightHandPinky2"].rotation.z = object["rightHandPinky2Rz"]; 
				archerStructure["rightHandPinky3"].rotation.z = object["rightHandPinky3Rz"]; 
				archerStructure["rightHandPinky4"].rotation.z = object["rightHandPinky4Rz"]; 
				archerStructure["rightHandRing2"].rotation.z = object["rightHandRing2Rz"]; 
				archerStructure["rightHandRing3"].rotation.z = object["rightHandRing3Rz"]; 
				archerStructure["rightHandRing4"].rotation.z = object["rightHandRing4Rz"]; 
				archerStructure["rightHandMiddle2"].rotation.z = object["rightHandMiddle2Rz"]; 
				archerStructure["rightHandMiddle3"].rotation.z = object["rightHandMiddle3Rz"]; 
				archerStructure["rightHandMiddle4"].rotation.z = object["rightHandMiddle4Rz"]; 
				archerStructure["rightHandIndex2"].rotation.z = object["rightHandIndex2Rz"]; 
				archerStructure["rightHandIndex3"].rotation.z = object["rightHandIndex3Rz"]; 
				archerStructure["rightHandIndex4"].rotation.z = object["rightHandIndex4Rz"]; 
				archerStructure["rightHandThumb2"].rotation.y = object["rightHandThumb2Ry"];archerStructure["rightHandThumb2"].rotation.z = object["rightHandThumb2Rz"]; 
				archerStructure["rightHandThumb3"].rotation.y = object["rightHandThumb3Ry"];archerStructure["rightHandThumb3"].rotation.z = object["rightHandThumb3Rz"]; 
				archerStructure["rightHandThumb4"].rotation.y = object["rightHandThumb4Ry"];archerStructure["rightHandThumb4"].rotation.z = object["rightHandThumb4Rz"]; 
				archerStructure["leftHandPinky2"].rotation.z = object["leftHandPinky2Rz"]; 
				archerStructure["leftHandPinky3"].rotation.z = object["leftHandPinky3Rz"]; 
				archerStructure["leftHandPinky4"].rotation.z = object["leftHandPinky4Rz"]; 
				archerStructure["leftHandRing2"].rotation.z = object["leftHandRing2Rz"]; 
				archerStructure["leftHandRing3"].rotation.z = object["leftHandRing3Rz"]; 
				archerStructure["leftHandRing4"].rotation.z = object["leftHandRing4Rz"]; 
				archerStructure["leftHandMiddle2"].rotation.z = object["leftHandMiddle2Rz"]; 
				archerStructure["leftHandMiddle3"].rotation.z = object["leftHandMiddle3Rz"]; 
				archerStructure["leftHandMiddle4"].rotation.z = object["leftHandMiddle4Rz"]; 
				archerStructure["leftHandIndex2"].rotation.z = object["leftHandIndex2Rz"]; 
				archerStructure["leftHandIndex3"].rotation.z = object["leftHandIndex3Rz"]; 
				archerStructure["leftHandIndex4"].rotation.z = object["leftHandIndex4Rz"]; 
				archerStructure["leftHandThumb2"].rotation.y = object["leftHandThumb2Ry"];archerStructure["leftHandThumb2"].rotation.z = object["leftHandThumb2Rz"]; 
				archerStructure["leftHandThumb3"].rotation.y = object["leftHandThumb3Ry"];archerStructure["leftHandThumb3"].rotation.z = object["leftHandThumb3Rz"]; 
				archerStructure["leftHandThumb4"].rotation.y = object["leftHandThumb4Ry"];archerStructure["leftHandThumb4"].rotation.z = object["leftHandThumb4Rz"]; 				
			};

			idle = new TWEEN.Tween(startRotations).to({"rightShoulderRx": -0.0000,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0.0000,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": -0.0000,"rightLowerArmRy": -0.0000,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": -0.0000,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0.0000,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": -0.0000,"leftLowerArmRy": -0.0000,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": -0.0010,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": 0.0020,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": -0.0010,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": 0.0021,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 1000);
			
			
													
			jumpA = new TWEEN.Tween(startRotations).to({"rightShoulderRx": Math.PI/2,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": Math.PI/2,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": Math.PI/2,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": -Math.PI/2,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": -Math.PI/3,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": Math.PI/4,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": Math.PI/3,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": Math.PI/9,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 800);
			
			jumpB = new TWEEN.Tween(startRotations).to({"rightShoulderRx": Math.PI/2,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": Math.PI/2,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": Math.PI/2,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": -Math.PI/2,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": -Math.PI/5,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": Math.PI/9,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": Math.PI/5,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": Math.PI/9,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 800);

			walkA = new TWEEN.Tween(startRotations).to({"rightShoulderRx": Math.PI/9,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": Math.PI/9,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": -Math.PI/9,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": -Math.PI/9,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": Math.PI/5,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": Math.PI/9,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": -Math.PI/5,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": Math.PI/9,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 400);
			
			walkB = new TWEEN.Tween(startRotations).to({"rightShoulderRx": -Math.PI/9,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": Math.PI/9,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": Math.PI/9,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": -Math.PI/9,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": -Math.PI/3,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": Math.PI/4,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": Math.PI/3,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": Math.PI/9,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 400).onComplete(() => walkA.start());


			runA = new TWEEN.Tween(startRotations).to({"rightShoulderRx": Math.PI/4,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": Math.PI/4,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": -Math.PI/4,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": -Math.PI/4,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": Math.PI/3,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": Math.PI/9,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": -Math.PI/3,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": Math.PI/9,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 400);
			
			runB = new TWEEN.Tween(startRotations).to({"rightShoulderRx": -Math.PI/4,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": Math.PI/4,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": Math.PI/4,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": -Math.PI/4,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": -Math.PI/3,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": Math.PI/9,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": Math.PI/3,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": Math.PI/9,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 400).onComplete(() => runA.start());

			shootA = new TWEEN.Tween(startRotations).to({"rightShoulderRx": -Math.PI/2,"rightShoulderRy": -0.0000,"rightShoulderRz": Math.PI/9, 
														"rightUpperArmRx": 0,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": 0,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": -Math.PI/2,"leftShoulderRy": -0.0000,"leftShoulderRz": -Math.PI/6, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": 0,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0,"leftHandRy": -0.0000,"leftHandRz": Math.PI/10, 
														"rightUpperLegRx": -0,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": 0,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": 0,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": 0,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2619, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 400).onComplete(() => {
															shootB.start()		
														});
			shootA.onStart(() => {
															var cameraAngle = Math.atan2(
																(camera.position.x - cubeBody.position.x),
																(camera.position.z - cubeBody.position.z));
																
														//Player has to be rotated in the correct direction in order to shoot
														var desQuat = (new THREE.Quaternion()).setFromAxisAngle(new THREE.Vector3(0,1,0), cameraAngle + relDir);
														cubeMesh.quaternion.copy(desQuat);
														});

			shootB = new TWEEN.Tween(startRotations).to({"rightShoulderRx": -Math.PI/2,"rightShoulderRy": -0.0000,"rightShoulderRz": Math.PI/8, 
														"rightUpperArmRx": Math.PI/2,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": 0,"rightLowerArmRy": Math.PI/2,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": -Math.PI/2,"leftShoulderRy": -0.0000,"leftShoulderRz": -Math.PI/6, 
														"leftUpperArmRx": 0,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": 0,"leftLowerArmRy": 0,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": Math.PI/10, 
														"rightUpperLegRx": -0,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": 0,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": 0,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": 0,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 400).onComplete(() => {
															throwArrow();
															shootC.start()		
														});

			shootC = new TWEEN.Tween(startRotations).to({"rightShoulderRx": -0.0000,"rightShoulderRy": -0.0000,"rightShoulderRz": -0.0000, 
														"rightUpperArmRx": 0.0000,"rightUpperArmRy": 0.0000,"rightUpperArmRz": 1.3659, 
														"rightLowerArmRx": -0.0000,"rightLowerArmRy": -0.0000,"rightLowerArmRz": 0.0000, 
														"rightHandRx": 0.0005,"rightHandRy": 0.0000,"rightHandRz": -0.0000, 
														"leftShoulderRx": -0.0000,"leftShoulderRy": -0.0000,"leftShoulderRz": 0.0000, 
														"leftUpperArmRx": 0.0000,"leftUpperArmRy": -0.0000,"leftUpperArmRz": -1.3659, 
														"leftLowerArmRx": -0.0000,"leftLowerArmRy": -0.0000,"leftLowerArmRz": -0.0000, 
														"leftHandRx": 0.0005,"leftHandRy": -0.0000,"leftHandRz": 0.0000, 
														"rightUpperLegRx": -0.0010,"rightUpperLegRy": 0.0000,"rightUpperLegRz": -0.0001, 
														"rightLowerLegRx": 0.0020,"rightLowerLegRy": 0.0000,"rightLowerLegRz": -0.0000, 
														"rightFootRx": -0.0010,"rightFootRy": -0.0000,"rightFootRz": 0.0001, 
														"leftUpperLegRx": -0.0010,"leftUpperLegRy": 0.0000,"leftUpperLegRz": -0.0001, 
														"leftLowerLegRx": 0.0021,"leftLowerLegRy": 0.0000,"leftLowerLegRz": 0.0000, 
														"leftFootRx": -0.0010,"leftFootRy": -0.0000,"leftFootRz": 0.0001, 
														"neckRx": -0.0000,"neckRy": -0.0000,"neckRz": -0.0000, 
														"headRx": 0.0000,"headRy": 0.0000,"headRz": -0.0000,
														"rightHandPinky2Rz": 1.0472, 
														"rightHandPinky3Rz": 1.0472, 
														"rightHandPinky4Rz": 1.0472, 
														"rightHandRing2Rz": 1.0472, 
														"rightHandRing3Rz": 1.0472, 
														"rightHandRing4Rz": 1.0472, 
														"rightHandMiddle2Rz": 1.0472, 
														"rightHandMiddle3Rz": 1.0472, 
														"rightHandMiddle4Rz": 1.0472, 
														"rightHandIndex2Rz": 1.0472, 
														"rightHandIndex3Rz": 1.0472, 
														"rightHandIndex4Rz": 1.0472, 
														"rightHandThumb2Rz": -0.2618, 
														"rightHandThumb3Rz": -0.2618, 
														"rightHandThumb4Rz": -0.2618,
														"rightHandThumb2Ry": -0.7854, 
														"rightHandThumb3Ry": -0.7854, 
														"rightHandThumb4Ry": -0.7854, 
														"leftHandPinky2Rz": -1.0472, 
														"leftHandPinky3Rz": -1.0472, 
														"leftHandPinky4Rz": -1.0472, 
														"leftHandRing2Rz": -1.0472, 
														"leftHandRing3Rz": -1.0472, 
														"leftHandRing4Rz": -1.0472, 
														"leftHandMiddle2Rz": -1.0472, 
														"leftHandMiddle3Rz": -1.0472, 
														"leftHandMiddle4Rz": -1.0472, 
														"leftHandIndex2Rz": -1.0472, 
														"leftHandIndex3Rz": -1.0472, 
														"leftHandIndex4Rz": -1.0472, 
														"leftHandThumb2Rz": 0.2618, 
														"leftHandThumb3Rz": 0.2618, 
														"leftHandThumb4Rz": 0.2618,
														"leftHandThumb2Ry": 0.7854, 
														"leftHandThumb3Ry": 0.7854, 
														"leftHandThumb4Ry": 0.7854}, 400).onComplete(() => {
															canShoot=true;		
														});

			idle.onUpdate(updateFunction);
			runA.onUpdate(updateFunction);
			runB.onUpdate(updateFunction);
			walkA.onUpdate(updateFunction);
			walkB.onUpdate(updateFunction);
			jumpA.onUpdate(updateFunction);
			shootA.onUpdate(updateFunctionUpper);
			shootB.onUpdate(updateFunctionUpper);
			shootC.onUpdate(updateFunctionUpper);
			runA.chain(runB);
			walkA.chain(walkB);

		});



		//CUBE (CANNON)
		const cubePhysMat = new CANNON.Material();

		const cubeBody = new CANNON.Body({
			mass: 10,
			shape: new CANNON.Box(new CANNON.Vec3(0.7, 1.5, 1.0)),
			position: new CANNON.Vec3(0, 5, 0),
			material: cubePhysMat,
			linearDamping: 0.5,
 		    angularDamping: 1,
		});
		world.addBody(cubeBody);

		function shoot(){
			shootA.start();
		}

		function throwArrow(){
			//START ANIMATION HERE AND ONLY ON FIRST PHASE COMPLETE SHOOT, THEN AT THE COMPLETE END RESET CANSHOOT TO TRUE
			var cameraDirection= new THREE.Vector3();
			camera.getWorldDirection(cameraDirection);

			//Vertical direction not useful for movement, player can't fly
			cameraDirection.y = 0;
			cameraDirection.normalize();
			cameraDirection.applyAxisAngle(new THREE.Vector3(0,1,0), relDir);
			var moveX = cameraDirection.x;
			var moveZ = cameraDirection.z;
			var arrowDirection = new THREE.Vector3(moveX, 0, 0);
			arrowDirection.add(new THREE.Vector3(0, 0, moveZ));


			var cubeArrowCan = new CANNON.Body({
				mass: 2,
				shape: new CANNON.Box(new CANNON.Vec3(0.05, 0.05, 0.35 )),  
				position: new CANNON.Vec3(archerModelParent.position.x + 2*moveX, archerModelParent.position.y+0.8, archerModelParent.position.z + 2*moveZ),
				material: cubePhysMat,
				linearDamping: 0.5,
				angularDamping: 1,
			});
			
			var cubeArrowMesh = new THREE.Mesh( new THREE.BoxGeometry( 0.1 , 0.1, 0.7), new THREE.MeshPhongMaterial( { color: 0x00ff00, wireframe: true} ));
			
			var cubeArrowModel = arrowModel.clone();
			
			var cubeArrowModelParent = new THREE.Object3D();
			cubeArrowModel.getWorldPosition(cubeArrowModelParent.position);
			cubeArrowModel.position.set(0 , 0, -cubeArrowMesh.geometry.parameters.depth/2);
			cubeArrowModelParent.add(cubeArrowModel);
			
			scene.add( cubeArrowMesh );
			scene.add( cubeArrowModelParent );
			
			world.addBody(cubeArrowCan);
			cubeArrowModelParent.lookAt(arrowDirection);

			var arrowVelocity = 40;

			cubeArrowCan.velocity.z = arrowVelocity * moveZ;
			cubeArrowCan.velocity.x = arrowVelocity * moveX;
			
			arrows.push(({"can":cubeArrowCan, "mesh":cubeArrowMesh, "model":cubeArrowModelParent}));

		}


		var targetBody1 = new CANNON.Body({
			shape: new CANNON.Cylinder(0.5,0.5,0.25,10),
			position: new CANNON.Vec3(-2, 2, 20),
			type: CANNON.Body.STATIC
		});
		const targetMesh1 = new THREE.Mesh( new THREE.CylinderGeometry( 1, 1, 0.5, 10 ), new THREE.MeshPhongMaterial( { color: 0x00ff00, wireframe: true} ) );
		scene.add(targetMesh1);
		targetBody1.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0), Math.PI / 2);
		world.addBody(targetBody1);		
		
		var targetBody2 = new CANNON.Body({
			shape: new CANNON.Cylinder(0.5,0.5,0.25,10),
			position: new CANNON.Vec3(2, 2, 20),
			type: CANNON.Body.STATIC
		});
		const targetMesh2 = new THREE.Mesh( new THREE.CylinderGeometry( 1, 1, 0.5, 10 ), new THREE.MeshPhongMaterial( { color: 0x00ff00, wireframe: true} ) );
		scene.add(targetMesh2);
		targetBody2.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0), Math.PI / 2);
		world.addBody(targetBody2);
		

		//GROUND (THREE)
		const groundGeo = new THREE.BoxGeometry( 30, 30, 2.0 );
		const groundMat = new THREE.MeshPhongMaterial({ 
			color: 0xffffff,
			side: THREE.DoubleSide,
			wireframe: false
			});
		const groundMesh = new THREE.Mesh(groundGeo, groundMat);
		scene.add(groundMesh);
		groundMesh.receiveShadow=true;
		groundMesh.castshadow=true;

		//GROUND (CANNON)
		const groundPhysMat = new CANNON.Material();


		const groundBody = new CANNON.Body({
			shape: new CANNON.Box(new CANNON.Vec3(15, 15, 1)),
			type: CANNON.Body.STATIC,
			material: groundPhysMat
		});
		world.addBody(groundBody);
		groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);

		//CONTACT MATERIALS (CANNON)
		const groundBoxContactMat = new CANNON.ContactMaterial(
			groundPhysMat,
			cubePhysMat,
			{contactEquationRelaxation : 1000},
			{restitution : 0}
		);

		world.addContactMaterial(groundBoxContactMat);

		//EVENT LISTENERS
		window.addEventListener('resize', function() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		});

		var pressed = {"SHIFT" : false, "W" : false, "A" : false, "S" : false, "D" : false, "F" : false};
		
		document.addEventListener('keydown',(event) => {
			if(event.key.toLowerCase() == " ") pressed["SPACE"] = true;
			if(event.key.toLowerCase() == "shift") pressed["SHIFT"] = true;
			if(event.key.toLowerCase() == "w") pressed["W"] = true;
			if(event.key.toLowerCase() == "a") pressed["A"] = true;
			if(event.key.toLowerCase() == "s") pressed["S"] = true;
			if(event.key.toLowerCase() == "d") pressed["D"] = true;
			if(event.key.toLowerCase() == "f") pressed["F"] = true;
		},false);
		
		document.addEventListener('keyup',(event) => {
			if(event.key.toLowerCase() == " ") pressed["SPACE"] = false;
			if(event.key.toLowerCase() == "shift") pressed["SHIFT"] = false;
			if(event.key.toLowerCase() == "w") pressed["W"] = false;
			if(event.key.toLowerCase() == "a") pressed["A"] = false;
			if(event.key.toLowerCase() == "s") pressed["S"] = false;
			if(event.key.toLowerCase() == "d") pressed["D"] = false;
			if(event.key.toLowerCase() == "f") pressed["F"] = false;
		},false);

		cubeBody.addEventListener( "collide", function (e) {
			//Since e.contact.bi and e.contact.bj are the bodies colliding we would like to discover which is the player, in order to know if he is colliding with a floor or something else looking at the collision normal of the other object
			//the normal of collision with respect to the body e.contact.bi is contained inside e.contact.ni
			
			//if e.contact.ni is the collision normal of the player then we negate it to obtain the collision normal of the other object
			if ( e.contact.bi.id == cubeBody.id ) {
			e.contact.ni.negate( e.contact.ni );
			}

			// If the dot product between the vertical positive axis and the contact normal is between 0 and 1 then we know that the player is hitting a floor (or a surface to which he could stand)
			if ( e.contact.ni.dot( new CANNON.Vec3( 0, 1, 0 ) ) > 0.5) playerState = "Idle";
		});

		const time = new THREE.Clock();
		function animate() {
			world.step(1/60);
			TWEEN.update();

			playerAnimate(time.getDelta());

			groundMesh.position.copy(groundBody.position);
			groundMesh.quaternion.copy(groundBody.quaternion);

			if(cubeMesh){
				cubeMesh.position.copy(cubeBody.position);
				//CubeMesh copies the cubeBody rotation because threejs offers the rotateTowards function to rotate gradually during movement
				cubeBody.quaternion.copy(cubeMesh.quaternion);
			}

			if(cubeBody && archerModelParent){
				archerModelParent.position.copy(cubeBody.position);
				archerModelParent.quaternion.copy(cubeBody.quaternion);
			}

			if(targetBody1 && targetModelParent1 && targetMesh1){
				targetModelParent1.position.copy(targetBody1.position);
				targetModelParent1.quaternion.copy(targetBody1.quaternion);
				targetMesh1.quaternion.copy(targetBody1.quaternion);
				targetMesh1.position.copy(targetBody1.position);
			}
			if(targetBody2 && targetModelParent2 && targetMesh2){
				targetModelParent2.position.copy(targetBody2.position);
				targetModelParent2.quaternion.copy(targetBody2.quaternion);
				targetMesh2.quaternion.copy(targetBody2.quaternion);
				targetMesh2.position.copy(targetBody2.position);
			}

			//if (mixer) mixer.update(time.getDelta());
			arrows.forEach(element => {
				element["mesh"].position.copy(element["can"].position);
				element["model"].position.copy(element["can"].position);
				element["can"].quaternion.copy(element["model"].quaternion);
				element["mesh"].quaternion.copy(element["model"].quaternion);

			});

			renderer.render( scene, camera );

			requestAnimationFrame(animate);
		};

		//Set elements of archer useful for animations
		function populateArcherStructure(){
			archerStructure["rightShoulder"] = archerModel.getObjectByName('RightShoulder_52');
			archerStructure["rightUpperArm"] = archerModel.getObjectByName('RightArm_51');
			archerStructure["rightLowerArm"] = archerModel.getObjectByName('RightForeArm_50');
			archerStructure["rightHand"] = archerModel.getObjectByName('RightHand_49');
			archerStructure["leftShoulder"] = archerModel.getObjectByName('LeftShoulder_28');
			archerStructure["leftUpperArm"] = archerModel.getObjectByName('LeftArm_27');
			archerStructure["leftLowerArm"] = archerModel.getObjectByName('LeftForeArm_26');
			archerStructure["leftHand"] = archerModel.getObjectByName('LeftHand_25');
			archerStructure["rightUpperLeg"] = archerModel.getObjectByName('RightUpLeg_65');
			archerStructure["rightLowerLeg"] = archerModel.getObjectByName('RightLeg_64');
			archerStructure["rightFoot"] = archerModel.getObjectByName('RightFoot_63');
			archerStructure["leftUpperLeg"] = archerModel.getObjectByName('LeftUpLeg_60');
			archerStructure["leftLowerLeg"] = archerModel.getObjectByName('LeftLeg_59');
			archerStructure["leftFoot"] = archerModel.getObjectByName('LeftFoot_58');
			archerStructure["neck"] = archerModel.getObjectByName('Neck_4');
			archerStructure["head"] = archerModel.getObjectByName('Head_3');
			archerStructure["rightHandPinky2"] = archerModel.getObjectByName('RightHandPinky2_31');
			archerStructure["rightHandPinky3"] = archerModel.getObjectByName('RightHandPinky3_30');
			archerStructure["rightHandPinky4"] = archerModel.getObjectByName('RightHandPinky4_29');
			archerStructure["rightHandRing2"] = archerModel.getObjectByName('RightHandRing2_35');
			archerStructure["rightHandRing3"] = archerModel.getObjectByName('RightHandRing3_34');
			archerStructure["rightHandRing4"] = archerModel.getObjectByName('RightHandRing4_33');
			archerStructure["rightHandMiddle2"] = archerModel.getObjectByName('RightHandMiddle2_39');
			archerStructure["rightHandMiddle3"] = archerModel.getObjectByName('RightHandMiddle3_38');
			archerStructure["rightHandMiddle4"] = archerModel.getObjectByName('RightHandMiddle4_37');
			archerStructure["rightHandIndex2"] = archerModel.getObjectByName('RightHandIndex2_43');
			archerStructure["rightHandIndex3"] = archerModel.getObjectByName('RightHandIndex3_42');
			archerStructure["rightHandIndex4"] = archerModel.getObjectByName('RightHandIndex4_41');
			archerStructure["rightHandThumb2"] = archerModel.getObjectByName('RightHandThumb2_47');
			archerStructure["rightHandThumb3"] = archerModel.getObjectByName('RightHandThumb3_46');
			archerStructure["rightHandThumb4"] = archerModel.getObjectByName('RightHandThumb4_45');
			archerStructure["leftHandPinky2"] = archerModel.getObjectByName('LeftHandPinky2_23');
			archerStructure["leftHandPinky3"] = archerModel.getObjectByName('LeftHandPinky3_22');
			archerStructure["leftHandPinky4"] = archerModel.getObjectByName('LeftHandPinky4_21');
			archerStructure["leftHandRing2"] = archerModel.getObjectByName('LeftHandRing2_19');
			archerStructure["leftHandRing3"] = archerModel.getObjectByName('LeftHandRing3_18');
			archerStructure["leftHandRing4"] = archerModel.getObjectByName('LeftHandRing4_17');
			archerStructure["leftHandMiddle2"] = archerModel.getObjectByName('LeftHandMiddle2_15');
			archerStructure["leftHandMiddle3"] = archerModel.getObjectByName('LeftHandMiddle3_14');
			archerStructure["leftHandMiddle4"] = archerModel.getObjectByName('LeftHandMiddle4_13');
			archerStructure["leftHandIndex2"] = archerModel.getObjectByName('LeftHandIndex2_11');
			archerStructure["leftHandIndex3"] = archerModel.getObjectByName('LeftHandIndex3_10');
			archerStructure["leftHandIndex4"] = archerModel.getObjectByName('LeftHandIndex4_9');
			archerStructure["leftHandThumb2"] = archerModel.getObjectByName('LeftHandThumb2_7');
			archerStructure["leftHandThumb3"] = archerModel.getObjectByName('LeftHandThumb3_6');
			archerStructure["leftHandThumb4"] = archerModel.getObjectByName('LeftHandThumb4_5');
		};

		//Set the correct player animation
		function changePlayerState(){
			if(lastExecutedAnimation == playerState) return;
			lastExecutedAnimation = playerState;
			idle.stop();
			walkA.stop();
			walkB.stop();
			runA.stop();
			runB.stop();
			jumpA.stop();
			jumpB.stop();
			switch(playerState){
				case "Idle":
					idle.start();
					break;
				case "Walk":
					walkA.start();
					break;
				case "Run":
					runA.start();
					break;
				case "Jump":
					jumpA.start();
					break;
				default:
					break;
			}
		}

		//Functions that applies the updates to the player through each frame (animation, movement, etc.)
		function playerAnimate(delta){

			//Degree of desired direction
			
			if(pressed["SPACE"] && playerState!="Jump"){
				playerState = "Jump";
				cubeBody.velocity.y = 10;
			}
			else if(pressed["SHIFT"] && playerState!="Jump")
				playerState = "Run";
			else if(playerState!="Jump")
				playerState = "Walk";
			
			if(pressed["F"] && canShoot){
				canShoot=false;
				shoot();
			}

			if(pressed["W"] && pressed["A"]){
				relDir = Math.PI/4;
			}
			else if(pressed["W"] && pressed["D"]){
				relDir = -Math.PI/4;
			}
			else if(pressed["S"] && pressed["A"]){
				relDir = 3*Math.PI/4;
			}
			else if(pressed["S"] && pressed["D"]){
				relDir = -3*Math.PI/4;
			}
			else if(pressed["W"]){
				relDir = 0;
			}
			else if(pressed["A"]){
				relDir = Math.PI/2;
			}
			else if(pressed["S"]){
				relDir = Math.PI;
			}
			else if(pressed["D"]){
				relDir = -Math.PI/2;
			}
			else  if(playerState!="Jump") {
				playerState = "Idle";
			}

			if(playerState == "Run" || playerState == "Walk" || playerState =="Jump"){
				//Camera angle with respect to player (obtained through x and z displacements)
				var cameraAngle = Math.atan2(
					(camera.position.x - cubeBody.position.x),
					(camera.position.z - cubeBody.position.z));

				//Desired final direction, that has to be reached slowly (using rotateTowards)
				var desQuat = (new THREE.Quaternion()).setFromAxisAngle(new THREE.Vector3(0,1,0), cameraAngle + relDir);
				cubeMesh.quaternion.rotateTowards(desQuat, 0.2);

				//Obtain the world direction of the camera
				var cameraDirection= new THREE.Vector3();
				camera.getWorldDirection(cameraDirection);

				//Vertical direction not useful for movement, player can't fly
				cameraDirection.y = 0;
				cameraDirection.normalize();
				cameraDirection.applyAxisAngle(new THREE.Vector3(0,1,0), relDir);
				var moveX = cameraDirection.x * (playerState == 'Run' ? 10 : 1.0) * delta;
				var moveZ = cameraDirection.z * (playerState == 'Run' ? 10 : 1.0) * delta;
				cubeBody.position.x += moveX;
				cubeBody.position.z += moveZ;
				camera.position.x += moveX;
				camera.position.z += moveZ;

				// update camera target
				cameraTarget.x = cubeBody.position.x;
				cameraTarget.y = cubeBody.position.y + 1;
				cameraTarget.z = cubeBody.position.z;
				orbit.target = cameraTarget;
        }

		changePlayerState();
		};

		requestAnimationFrame(animate);

		function dumpObject(obj, lines = [], isLast = true, prefix = '') {
  const localPrefix = isLast ? '└─' : '├─';
  lines.push(`${prefix}${prefix ? localPrefix : ''}${obj.name || '*no-name*'} [${obj.type}]`);
  const newPrefix = prefix + (isLast ? '  ' : '│ ');
  const lastNdx = obj.children.length - 1;
  obj.children.forEach((child, ndx) => {
    const isLast = ndx === lastNdx;
    dumpObject(child, lines, isLast, newPrefix);
  });
  return lines;
}
		</script>
	</body>
</html>