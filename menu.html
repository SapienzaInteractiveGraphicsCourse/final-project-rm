<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>TheArcher</title>
		<link rel="icon" type="image/x-icon" href="/img/favicon.png">
		<style>
			body { margin: 0;
				background: #000;
				font-family: Helvetica, sans-serif; }
			
			.example {
			float: left;
			margin: 10px;
			}
			.inp {
			background: rgba(0,127,128,0.68);
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
			border: 1px solid rgba(128,255,255,0.25);
			color: rgba(255,255,255,0.75);
			text-shadow: 0 0 10px rgba(0,255,255,0.95);
			font-size: 30px;
			padding: 10px 30px;
			text-shadow: 0 0 10px rgba(0,255,255,0.5);
			outline: none;
			}
			.inp:hover {
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			border: 1px solid rgba(128,255,255,0.75);
			}
			.inp:focus {
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			border: 1px solid rgba(128,255,255,0.75);
			}
			.inp-secondary {
			background-color: transparent;
			color: rgba(0,127,128,0.8);
			text-shadow: 0 0 12px rgba(0,255,255,0.3);
			/* text-shadow: none; */
			border: 1px solid rgba(128,255,255,0.5);
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.25);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.25);
			}
			.btn {
			background: rgba(0,127,128,1);
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
			border: 1px solid rgba(128,255,255,0.25);
			color: rgba(255,255,255,1);
			text-shadow: 0 0 10px rgba(0,255,255,0.95);
			font-size: 30px;
			padding: 10px 30px;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			outline: none;
			}
			.btn:hover {
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			border: 1px solid rgba(128,255,255,0.75);
			}
			.btn-primary:active {
			background: rgba(0,127,128,0.9);
			}
			.btn-secondary {
			background-color: transparent;
			color: rgba(0,127,128,0.8);
			text-shadow: 0 0 12px rgba(0,255,255,0.3);
			/* text-shadow: none; */
			border: 1px solid rgba(128,255,255,0.5);
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.25);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.25);
			}
			.btn-secondary:active {
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			}
			.element {
			position: relative;
			width: 120px;
			height: 160px;
			color: #fff;
			text-align: center;
			background: rgba(0,127,128,0.68);
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
			border: 1px solid rgba(128,255,255,0.25);
			cursor: default;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			}
			.element:hover {
			-webkit-box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
			border: 1px solid rgba(128,255,255,0.75);
			}
			.element .number {
			font-size: 12px;
			color: rgba(128,255,255,0.75);
			position: absolute;
			top: 20px;
			right: 20px;
			}
			.element .symbol {
			color: rgba(255,255,255,0.75);
			text-shadow: 0 0 10px rgba(0,255,255,0.95);
			position: absolute;
			font-size: 60px;
			font-weight: bold;
			top: 40px;
			left: 0px;
			right: 0px;
			}
			.element .details {
			font-size: 12px;
			color: rgba(128,255,255,0.75);
			position: absolute;
			bottom: 15px;
			left: 0px;
			right: 0px;
			}

		</style>
	</head>
	<body>
        <!-- Remove this when import maps will be widely supported -->
		<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>


        <!-- Needed to make the import "three" work-->
		<script type="importmap">
			{
				"imports": {
					"three": "./node_modules/three/build/three.module.js"
				}
			}
		</script>

        <!-- Initial loading bar -->
        <div id="gameLoading_bg" style="position:fixed; width : 100%; height : 100%; background-color: rgba(0,0,0,1);">
			<div id="gameLoading_fg" style="width: 70%; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); height: auto; text-align: center; cursor: pointer; padding: 2%;">
				<label id="gameLoading_label" style=" font-size: 3em; color:white;" for="gameLoading_fb_bar">Loading in progress:</label><br>
				<progress  id="gameLoading_fg_bar" style="width: 100%; height: 3em;" max="100" ></progress>
			</div>
		</div>

		
		
		<div id="start-menu" style="display:none">
			<div style = "width: 100%; position: fixed; top: 19%; left: 50%; transform: translate(-280pt, -50%);">
					<span >
						<img src="img/logo.png" width="800pt" >
					</span>
				</button>
			</div>
			<div style = "width: 100%; position: fixed; top: 50%; left: 50%; transform: translate(-30%, -50%);">
				<button id="start_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;   padding: 30pt;">
					<span >
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/start.png" width="50px">
						<span style="vertical-align:middle; font-size: 50px;"><b>START</b> </span>
					</span>
				</button>
			</div>
			<div style = "width: 100%; position: fixed; top: 70%; left: 50%; transform: translate(-30%, -50%);">
				<button id="settings_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;  padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/settings.png" width="50px">
						<span style="vertical-align:middle; font-size: 50px;"><b>OPTIONS</b> </span>
					</span>
				</button>
			</div>
			<div style = "width: 100%; position: fixed; top: 90%; left: 50%; transform: translate(-30%, -50%); ">
				<button id="credits_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;  padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/credits.png" width="50px">
						<span style="vertical-align:middle; font-size: 50px;"><b>CREDITS</b> </span>
					</span>
				</button>
			</div>
		</div>

		<div id="credits" style = "position:fixed; width : 100%; height : 100%; background-color: rgba(0,0,0,0.7); display:none;" >
			<div style = "width: 100%; position: fixed; top: 50%; left: 50%; transform: translate(-35%, -25%); ">
				<div class="btn btn-primary example" style=" display:block; opacity:0.95; width: 70%; height: 50%; text-align: center; ">
					<div id="close_credits_btn" style="display:inline-block; margin-left: 96%; color: white; font-weight: bold; cursor: pointer;">
						x
					</div>
					<span style="display:inline-block;width:100%;overflow: auto;">
						<span style=" vertical-align:middle; font-size: 50px;">Game created by: Riccardo Mascello<br>Models imported from Sketchfab, from the authors: </span>
					</span>
				</div>
			</div>

		</div>
		<div id="settings-menu" style="display:none">
			<div style = "width: 100%; position: fixed; top: 10%; left: 50%; transform: translate(-30%, -50%);">
				<button id="shadows_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;   padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/shadows.png" width="50px">
						<span id = "shadows_btn_txt" style="vertical-align:middle; font-size: 50px;"><b>SHADOWS</b> : MAX</span>
					</span>
				</button>
			</div>
			<div style = "width: 75%; position: fixed; top: 70%; left: 25%; transform: translate(-30%, -50%);">
				<button id="soundef_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;  padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/soundef.png" width="50px">
						<span id = "soundef_btn_txt" style="vertical-align:middle; font-size: 50px;"><b>EFFECTS</b> : ON</span>
					</span>
				</button>
			</div>
			<div style = "width: 75%; position: fixed; top: 70%; left: 75%; transform: translate(-30%, -50%);">
				<button id="soundmu_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;  padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/soundmu.png" width="50px">
						<span id = "soundmu_btn_txt" style="vertical-align:middle; font-size: 50px;"><b>MUSIC</b> : ON</span>
					</span>
				</button>
			</div>
			<div style = "width: 100%; position: fixed; top: 50%; left: 50%; transform: translate(-30%, -50%); ">
				<button id="wireframes_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;  padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/wireframes.png" width="50px">
						<span id = "wireframes_btn_txt" style="vertical-align:middle; font-size: 50px;"><b>WIREFRAMES</b> : OFF</span>
					</span>
				</button>
			</div>
			<div style = "width: 100%; position: fixed; top: 30%; left: 50%; transform: translate(-30%, -50%); ">
				<button id="clouds_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;  padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/clouds.png" width="50px">
						<span id = "clouds_btn_txt" style="vertical-align:middle; font-size: 50px;"><b>CLOUDS</b> : ON</span>
					</span>
				</button>
			</div>
			<div style = "width: 100%; position: fixed; top: 90%; left: 50%; transform: translate(-30%, -50%); ">
				<button id="back_btn" class="btn btn-primary example" style="opacity:0.95; width: 60%; height: auto; text-align: center; cursor: pointer;  padding: 30pt;">
					<span>
						<img style="-webkit-filter: invert(1); filter: invert(1); vertical-align:middle" src="img/back.png" width="50px">
						<span style="vertical-align:middle; font-size: 50px;"><b>BACK</b></span>
					</span>
				</button>
			</div>

			

		</div>

		<script type="module">
        import * as THREE from './node_modules/three/build/three.module.js';
        import { OrbitControls } from './node_modules/three/examples/jsm/controls/ModifiedOrbitControls.js';
		import * as CANNON from './node_modules/cannon-es/dist/cannon-es.js';
		import {GLTFLoader} from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';
		import { TWEEN } from './node_modules/three/examples/jsm/libs/tween.module.min.js'
		import { Sky } from './node_modules/three/examples/jsm/objects/Sky.js';

		var gameLoaded = false;
		var animateScene = false;
		var relDir=0;
		var playerState = "Idle";
		var cameraTarget = new THREE.Vector3();
		var mixer;
		var archerModel, archerModelParent;
		var arrowModel, targetModel, targetModel1, targetModel2,targetModel3, targetModel4;
		var targetModelParent1, targetModelParent2, targetModelParent3, targetModelParent4;
		var archerStructure = {};
		var canShoot=true;
		var lastExecutedAnimation = "Idle";
		var idle, idleB, runA, runB, runC, runD, jumpA, jumpB, walkA, walkB, walkC, walkD, shootPre, shootA, shootB, shootC, targetMovement1, targetMovement2, targetMovement3, targetMovement4, level2Unlock, level3Unlock1, level3Unlock2, level3Unlock3, level3Unlock4, level3Unlock5, level3Unlock6;
		var backObsPlat1, fwdObsPlat1, backObsPlat2, fwdObsPlat2, backObsPlat3, fwdObsPlat3;
		var arrows =[];
		var target1hit = false, target2hit = false, target3hit=false, target4hit=false;
		var prevPlayerPosition;
		var obsPlatTweens = [];
		var obsPlat=[];
		var robots=[];
		var robotsTweens = [];
		var oldx = 0, oldz = 0, oldy = 10;
		var cameraAngle, desQuat;
		var rotatingPlatModel;
		var rotatePlatFloatingTweens =[];
		var skyboxModel, mainPlatModel, groundPlatModelParent, level2PlatformModelParent, level3PlatformModelParent;
		var pause_bg = document.getElementById("pause_bg");
		var pause_fg = document.getElementById("pause_fg");
		var justRepulsedArcher = false;
		var arrowAnimation, archerRightHand;
		var bombs = [];
		var bombModel;
		var justShotCannon1 = false;
		var cannonBody, cannonModel, cannonModelParent, cannonMesh;
		var slModel, slModelParent;
        var targetBody1,targetMesh1, targetModelParent1;
        var targets=[];
        var targetSpeed = 0.0005;
        var targetRotation = 0.00001;
        var horizontalMax = 30;
        var verticalMax = 30;
        var generatingStep = 4;
        var targetsDepth = 20;
		var addedTarget = 0;

		//SETTINGS PARAMETERS
		var shadows = 3;
		var soundef = 1;
		var soundmu = 1;
		var wireframes = 0;
		var clouds = 1;

		function start(){
			if(soundef == 1)clickAudio.play();
			window.location.href = 'index.html?shadows='+shadows+'&soundef='+soundef+'&soundmu='+soundmu+'&wireframes='+wireframes;
		}
		document.querySelector("#start_btn").addEventListener("click",start);
		
		function openSettings(){
			if(soundef == 1)clickAudio.play();
			document.querySelector("#start-menu").style.display = "none";
			document.querySelector("#settings-menu").style.display = "";
		}
		document.querySelector("#settings_btn").addEventListener("click",openSettings);

		function closeSettings(){
			if(soundef == 1)clickAudio.play();
			document.querySelector("#start-menu").style.display = "";
			document.querySelector("#settings-menu").style.display = "none";
		}
		document.querySelector("#back_btn").addEventListener("click",closeSettings);

		function openCredits(){
			if(soundef == 1)clickAudio.play();
			document.querySelector("#credits").style.display = "";
		}
		document.querySelector("#credits_btn").addEventListener("click",openCredits);

		function closeCredits(){
			if(soundef == 1)clickAudio.play();
			document.querySelector("#credits").style.display = "none";
		}
		document.querySelector("#close_credits_btn").addEventListener("click",closeCredits);


		function changeShadows(){
			if(soundef == 1)clickAudio.play();
			if(shadows == 3){
				shadows = 2;
				document.querySelector("#shadows_btn_txt").innerHTML = "<b>SHADOWS</b> : MED";
			}
			else if(shadows == 2){
				shadows = 1;
				document.querySelector("#shadows_btn_txt").innerHTML = "<b>SHADOWS</b> : MIN";
			}
			else{
				shadows = 3;
				document.querySelector("#shadows_btn_txt").innerHTML = "<b>SHADOWS</b> : MAX";
			}
			dirLight.shadow.mapSize.width = Math.pow(2,4 * shadows); // default
			dirLight.shadow.mapSize.height = Math.pow(2,4 * shadows); // default
		}
		document.querySelector("#shadows_btn").addEventListener("click",changeShadows);

		function changeSoundEf(){
			if(soundef == 1)clickAudio.play();
			if(soundef == 1){
				soundef = 0;
				document.querySelector("#soundef_btn_txt").innerHTML = "<b>EFFECTS</b> : OFF";
			}
			else {
				soundef = 1;
				document.querySelector("#soundef_btn_txt").innerHTML = "<b>EFFECTS</b> : ON";
			}
		}
		document.querySelector("#soundef_btn").addEventListener("click",changeSoundEf);

		function changeSoundMu(){
			if(soundef == 1)clickAudio.play();
			if(soundmu == 1){
				soundmu = 0;
				if(mainThemeAudio.isPlaying)
					mainThemeAudio.stop();
				document.querySelector("#soundmu_btn_txt").innerHTML = "<b>MUSIC</b> : OFF";
			}
			else {
				soundmu = 1;
				mainThemeAudio.play();
				document.querySelector("#soundmu_btn_txt").innerHTML = "<b>MUSIC</b> : ON";
			}
		}
		document.querySelector("#soundmu_btn").addEventListener("click",changeSoundMu);

		function changeClouds(){
			if(soundef == 1)clickAudio.play();
			if(clouds == 1){
				clouds = 0;
				if(skyboxModel)
					scene.remove(skyboxModel);
				document.querySelector("#clouds_btn_txt").innerHTML = "<b>CLOUDS</b> : OFF";
			}
			else {
				clouds = 1;
				if(skyboxModel)
					scene.add(skyboxModel);
				document.querySelector("#clouds_btn_txt").innerHTML = "<b>CLOUDS</b> : ON";
			}
		}
		document.querySelector("#clouds_btn").addEventListener("click",changeClouds);

		function changeWireframes(){
			if(soundef == 1)clickAudio.play();
			if(wireframes == 1){
				wireframes = 0;
				targets.forEach(element => {
					element["mesh"].material.opacity = 0;
				});
				if(helper)
					scene.remove(helper);
				document.querySelector("#wireframes_btn_txt").innerHTML = "<b>WIREFRAMES</b> : OFF";
			}
			else {
				wireframes = 1;
				targets.forEach(element => {
					element["mesh"].material.opacity = 1;
				});
				if(helper)
					scene.add(helper);
				document.querySelector("#wireframes_btn_txt").innerHTML = "<b>WIREFRAMES</b> : ON";
			}
		}


		document.querySelector("#wireframes_btn").addEventListener("click",changeWireframes);
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        function onPointerClick( event ) {
			if(!mainThemeAudio.isPlaying && soundmu == "1") mainThemeAudio.play();
            // calculate pointer position in normalized device coordinates
            // (-1 to +1) for both components

            pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

            // update the picking ray with the camera and pointer position
            raycaster.setFromCamera( pointer, camera );

            // calculate objects intersecting the picking ray
            const intersects = raycaster.intersectObjects( scene.children );

            if(intersects[0]){
                targets.forEach(element => {
                    if(element["mesh"] == intersects[0].object){
                        element["body"].mass = 100;
                        element["body"].updateMassProperties();
                    }
                });
            }

        }

        window.addEventListener( 'pointerdown', onPointerClick );
		
		window.addEventListener('resize', function() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		});




		//CANNON AND THREE SETUP
		const world = new CANNON.World({
			gravity: new CANNON.Vec3(0, -20, 0)
		});

		const scene = new THREE.Scene();
		// scene.background = new THREE.Color( 0x00C0F0 );
		
		var sky = new Sky();
		sky.scale.setScalar( 450000 );
		scene.add( sky );
		var sunPosition = new THREE.Vector3();

		sky.material.uniforms[ 'turbidity' ].value =20;
		sky.material.uniforms[ 'mieCoefficient' ].value =0;
		sky.material.uniforms[ 'mieDirectionalG' ].value =1;
		sky.material.uniforms[ 'rayleigh' ].value =0.05;
		sunPosition.setFromSphericalCoords( 1, THREE.MathUtils.degToRad( 90 - 45 ), THREE.MathUtils.degToRad( 90 ) );
		sky.material.uniforms[ 'sunPosition' ].value.copy( sunPosition );

		const camera = new THREE.PerspectiveCamera(
			45,
			window.innerWidth / window.innerHeight,
			0.1,
			1000
			);
			
			
			const renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.shadowMap.enabled = true;
			document.body.appendChild( renderer.domElement );
			renderer.toneMappingExposure = 0.5;
			
			camera.position.set(0,0,-5);
			camera.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), Math.PI);

		//AUDIO

		const audioListener = new THREE.AudioListener();
		camera.add( audioListener );
		const audioLoader = new THREE.AudioLoader();

		const mainThemeAudio = new THREE.Audio( audioListener );

		audioLoader.load( 'sounds/mainTheme.mp3', function( buffer ) {
			mainThemeAudio.setBuffer( buffer );
			mainThemeAudio.setLoop( true );
			mainThemeAudio.setVolume( 0.5 );
		});

		const clickAudio = new THREE.Audio( audioListener );

		audioLoader.load( 'sounds/click.mp3', function( buffer ) {
			clickAudio.setBuffer( buffer );
			clickAudio.setVolume( 0.6 );
		});
		
		//LIGHT SETUP

		const ambLight = new THREE.AmbientLight(0xFFFFFF, 1);
		scene.add(ambLight);
		
		const dirLight = new THREE.DirectionalLight(0xFFFFFF, 10);
		dirLight.position.set(0, 50, -5);
		dirLight.target.position.set(0, 0, 20);
		dirLight.castShadow = true; 
		dirLight.shadow.camera.left = - 200;
		dirLight.shadow.camera.right = 15;
		dirLight.shadow.camera.top = 15;
		dirLight.shadow.camera.bottom = - 15;
		dirLight.shadow.camera.far = 100;
		dirLight.shadow.bias = - 0;
		dirLight.shadow.mapSize.width = Math.pow(2,12); // default
		dirLight.shadow.mapSize.height = Math.pow(2,12); // default
		scene.add(dirLight);
		scene.add(dirLight.target);

		const helper = new THREE.CameraHelper( dirLight.shadow.camera );

		//CUBE (THREE)

		
		const loadingManager = new THREE.LoadingManager();
        const gltfLoader = new GLTFLoader(loadingManager);
		loadingManager.onLoad = () => {gameLoaded = true; document.querySelector('#gameLoading_fg').style.display = 'none'; document.querySelector('#gameLoading_bg').style.display = 'none'; animateScene=false; document.querySelector('#start-menu').style.display = '';};
		loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
			document.querySelector('#gameLoading_fg_bar').setAttribute("value",`${itemsLoaded / itemsTotal * 100 | 0}`);
		};

		

        var positions = [];
        for(var i = 0 ; i <= (horizontalMax*2) / generatingStep; i++){
            for(var j = 0 ; j <= (verticalMax*2) / generatingStep; j++){
                positions.push(new THREE.Vector3( - horizontalMax + generatingStep * i, - verticalMax + generatingStep * j, targetsDepth));
            }
        }

		gltfLoader.load("gltf/skybox/scene.gltf", (gltf) => {
			skyboxModel = gltf.scene.getObjectByName("Sketchfab_Scene");
			skyboxModel.scale.setScalar( 1 );
			//Removing the sky (it causes issues with directional light)
			var sky= gltf.scene.getObjectByName("hoth_sky");
			sky.visible=false;
			skyboxModel.traverse( function( node ) {
				if (node.isMesh) { 
					node.castShadow = true;
					node.receiveShadow=true;
					node.frustumCulled=true;
			}
			} );
			scene.add(skyboxModel);
			skyboxModel.rotation.y = -0.50;
		});

		gltfLoader.load("gltf/target/scene.gltf", (gltf) => {
			targetModel = gltf.scene.getObjectByName("Sketchfab_Scene");
			targetModel.scale.setScalar( 0.3 );

			
			gltf.scene.traverse( function( node ) {
				if (node.isMesh) { 
					node.castShadow = true;
					node.receiveShadow=true;
					node.frustumCulled=false;
			}
			} );


            for(var i=0; i<positions.length; i++){
               createTarget(positions[i]);
            }
		});

	function createTarget(position){
        var genTargetModelParent = new THREE.Object3D();
        var genTargetModel = targetModel.clone();
        genTargetModel.getWorldPosition(genTargetModelParent.position);
        genTargetModel.rotation.set(...[Math.PI/2,0,0]);
        genTargetModelParent.add(genTargetModel);
		genTargetModelParent.position.set(position);
        scene.add(genTargetModelParent);

        var genTargetBody = new CANNON.Body({
            shape: new CANNON.Cylinder(1,1,0.5,10),
            position: position,
            type : CANNON.Body.DYNAMIC,
            mass:0
        });
        var genTargetMesh = new THREE.Mesh( new THREE.CylinderGeometry( 1, 1, 0.5, 10 ), new THREE.MeshPhongMaterial( { color: 0x00ff00, wireframe: true, transparent: true} ) );
		if(wireframes == 1)genTargetMesh.material.opacity = 1;
		else genTargetMesh.material.opacity = 0;
		genTargetMesh.position.set(position);
        scene.add(genTargetMesh);
        world.addBody(genTargetBody);		
        genTargetBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI/2);

        targets.push({"body" : genTargetBody, "mesh" : genTargetMesh, "model" : genTargetModelParent})
    }



		const time = new THREE.Clock();
		var deltaTime = 0;
		var elapsedTime = 0;
		function animate() {
			deltaTime = time.getDelta();
			if(animateScene == false){
				elapsedTime = time.getElapsedTime() * 1000;
				TWEEN.update();
				world.step(1/60,deltaTime,10);

				if(targets[0])
					addedTarget += (deltaTime * 1000 * targetSpeed);
				
				if(skyboxModel){
					skyboxModel.rotation.y -= (deltaTime * 1000 * targetRotation);
				}
								

				targets.forEach(element => {
					element["body"].position.x -= (deltaTime * 1000 * targetSpeed);

                    element["model"].position.copy(element["body"].position);
					element["model"].quaternion.copy(element["body"].quaternion);
					element["mesh"].quaternion.copy(element["body"].quaternion);
					element["mesh"].position.copy(element["body"].position);

					//Check if the target is falling down or out of scene
					if(element["body"].position.y < -verticalMax || element["body"].position.x < -horizontalMax){
							scene.remove(element["model"]);
							setTimeout(function() {
								world.removeBody(element["body"]);
							},0);
							scene.remove(element["mesh"]);
							targets = targets.filter(function(ele){ 
								return ele != element; 
							});
						}
                });

				if(addedTarget > generatingStep){
					var newPositions =[];
					for(var j=0; j<(verticalMax*2)/generatingStep; j++){
						newPositions.push(new THREE.Vector3(horizontalMax, - verticalMax + j * generatingStep, targetsDepth));
					}
					for(var i=0; i<newPositions.length; i++){
						createTarget(newPositions[i]);
					}
					addedTarget = 0;
				}
   
            }


			renderer.render( scene, camera );

			requestAnimationFrame(animate);
		};

		requestAnimationFrame(animate);

		function dumpObject(obj, lines = [], isLast = true, prefix = '') {
            const localPrefix = isLast ? '└─' : '├─';
            lines.push(`${prefix}${prefix ? localPrefix : ''}${obj.name || '*no-name*'} [${obj.type}]`);
            const newPrefix = prefix + (isLast ? '  ' : '│ ');
            const lastNdx = obj.children.length - 1;
            obj.children.forEach((child, ndx) => {
                const isLast = ndx === lastNdx;
                dumpObject(child, lines, isLast, newPrefix);
            });
            return lines;
        }

		</script>
	</body>
</html>